---
title: "Applied example"
author: "Rachael Caelie (Rocky) Aikens"
date: "12/2/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache=TRUE, warning = FALSE, message = FALSE, echo = FALSE, fig.align = "center", cache.lazy = F)
library(RACplots)
library(optmatch)
library(DOS2)
library(tidyverse)
library(ggpubr)
library(mice)
library(stratamatch)
library(knitr)
library(ggplotify)

theme_set(theme_light())
```

```{r}
AC_plot2 <- function(data, title = "", shaded_class = 1){
  if(shaded_class == "none"){
    plt_data <- data %>%
    mutate(t = as.factor(abs(1-t)),
           a = 0.9) %>%
    dplyr::select(c(t, prog, prop, a))
  } else{
     plt_data <- data %>%
      mutate(t = as.factor(abs(1-t)),
             a = ifelse(t == shaded_class, 0.9, 1)) %>%
      dplyr::select(c(t, prog, prop, a)) 
  }
  
  plt <- ggplot(data = plt_data, aes( x = prop, y = prog, group = t, color = t)) + 
    geom_point(size = 1, aes(alpha = a)) +
    scale_color_brewer(palette="Set1") +
    ggtitle(title) +
    theme(legend.position = "none", aspect.ratio=1, plot.title = element_text(hjust = 0.5, size = 9))+
    ylab(expression(paste("Prognosis, ", Psi, "(x)", sep = ""))) +
    xlab(expression(paste("Propensity, ", phi, "(x)", sep = "")))
  
  return(plt)
}
```


# Set-up

We'd like to ask the question: Do patients have better outcomes when their identities match their own?  To do so, we use a dataset of 1155903 coronary artery bypass grafting (cabg) surgeries on Medicare patients from 1998 to 2016.  We compare 30 day mortality for patients whose identities are matched to their primary surgeons with those whose identities are not.

Provider race is not recorded in the dataset, so we focus on sex/gender. Unfortunately, patients are characterized only by "sex" and providers are characterized only by "gender," and the data dictionaries don't really clarify what is meant by this. The remainder of this analysis will treat patient sex and provider gender match as "treated" and mismatch as "untreated." 

We consider only female patients in this analysis

## Data cleaning

The original dataset contained 382688 surgeries.  17 patients had a missing date for their surgery.  81233 had a recorded date, but no recorded gender information for their provider. No providers had any gender codes other than male or female. After excluding surgeries with missing surgery date or missing provider gender information, 301438 surgeries remained.

```{r}
# Read in CABG df and dataDict
cabg_raw <- read_csv("../data/cabg_cohort_rocky_12_01_2020.csv") %>% filter(BENE_SEX_CD == 2)
cabg_dataDict <- read_csv("../data/cabg_cohort_rocky_dataDict_12_02_2020.csv")
```
```{r}
cabg_raw %>% group_by(`Provider Gender Code`, is.na(surgdate)) %>% summarize(n())

# All Beneficiary IDs are distinct, so replacing BENE_ID with new ID column
cabg_df <- cabg_raw %>%
  select(- BENE_ID) %>%
  mutate(BENE_ID = 1:dim(.)[1]) %>%
  rename(PROVIDER_GENDER = `Provider Gender Code`) %>%
  filter(!is.na(surgdate), !is.na(PROVIDER_GENDER)) 
```

Most pre-treatment covariates are more than 20% missing.  Only ischemia, hyperlipidimia, and hypertension are less than 80% missing.  I recode admissions codes to be "Emergency", "Urgent", "Elective" or "Other", since codes besides emergency, urgent, or elective are quite rare in the dataset.

```{r}
# taking a look at what comorbidity information is present enough to keep
completeness <- summarize_all(cabg_df, function(x) mean(!is.na(x))) %>% slice(1) %>% as.numeric()
variance <- summarize_all(cabg_df, function(x) var(x, na.rm = T)) %>% slice(1) %>% as.numeric()

colstats <- tibble(value = colnames(cabg_df), completeness = completeness, variance = variance)

colstats %>% 
  filter(completeness > 0.8, 
         !endsWith(value, "bfdschrg"),
         !endsWith(value, "EVER_IND"),
         !endsWith(value, "YEAREND_IND"))
```

```{r}
set.seed(123)

# Since most admissions are 123 (Emergency, Urgent, or Elective), 
# I recode admission codes 0456789 to 0 = "Other"
cabg_cleaned <- cabg_df %>%
  select(BENE_ID, BENE_MDCR_STUS_CD, BENE_RSDNC_SSA_STATE_CD, 
         BENE_RACE_CD, BENE_SEX_CD, BENE_AGE_CNT, ADMSN_DAY_CD,
         IP_ADMSN_TYPE_CD, BENE_DEATH_DT,
         cabg_only, cabg_primary, surgdate, indexSurgyear, hosp_vol_99_10, 
         hosp_mvol_99_10, prior_cabg, PROVIDER_GENDER,
         ISCHEMICHEART_EVER_bfadmin, HYPERL_EVER_bfadmin, HYPERT_EVER_bfadmin) %>%
  mutate(MORT_30_DAY = ifelse(is.na(BENE_DEATH_DT), FALSE,
                              BENE_DEATH_DT < surgdate + 30),
         PROVIDER_GENDER = ifelse(PROVIDER_GENDER == "M", 1, 2),
         SEX_GENDER_MATCH = PROVIDER_GENDER == BENE_SEX_CD,
         BENE_MALE = BENE_SEX_CD == 1) %>% # recode SEX to binary. 1,2 coding sometimes causes bugs
  mutate(IP_ADMSN_TYPE_CD = ifelse(IP_ADMSN_TYPE_CD == 0 | IP_ADMSN_TYPE_CD > 3,
         0, IP_ADMSN_TYPE_CD)) %>%
  select(-c(BENE_DEATH_DT, PROVIDER_GENDER, surgdate, BENE_SEX_CD)) %>%
  mutate_at(c("BENE_MDCR_STUS_CD", "BENE_RSDNC_SSA_STATE_CD",
              "BENE_RACE_CD", "ADMSN_DAY_CD", "IP_ADMSN_TYPE_CD"),
            as.factor) %>%
  select(-BENE_MALE)
```

# Design

## Descriptive

Patients in 6944 surgeries had a primary surgeon who identified as female (2.36% of all surgeries.)

```{r fig.height=7, fig.width= 5}
cabg_cleaned %>% group_by(SEX_GENDER_MATCH) %>% summarize(n())

library(RItools)

plt_cabg <- cabg_cleaned %>%
  select(SEX_GENDER_MATCH, BENE_MDCR_STUS_CD, BENE_RACE_CD, BENE_AGE_CNT, 
         ADMSN_DAY_CD, IP_ADMSN_TYPE_CD, cabg_only, cabg_primary, indexSurgyear,
         hosp_vol_99_10, hosp_mvol_99_10, prior_cabg, ISCHEMICHEART_EVER_bfadmin,
         HYPERL_EVER_bfadmin, HYPERT_EVER_bfadmin)

colnames(plt_cabg) <- c("Female Surgeon", "Medicare Status Code", "Race", "Age",
                        "Admission Day", "Admission Type", "CABG only", "CABG primary", "Surgery Year",
                        "Hospital Volume", "Prior CABG", "Prior Ischemia",
                        "Prior Hyperlipidemia", "Prior Hypertension")

plot(xBalance(`Female Surgeon` ~ `Medicare Status Code` + Race + Age +
                `Admission Day` + `Admission Type` + `CABG only` +
                `CABG primary` + `Surgery Year` + `Hospital Volume` +
                `Prior CABG`,
              data = plt_cabg))

# save this for later
a <- as.ggplot(expression(plot(xBalance(`Female Surgeon` ~ `Medicare Status Code` + Race + Age +
                `Admission Day` + `Admission Type` + `CABG only` +
                `CABG primary` + `Surgery Year` + `Hospital Volume` +
                `Prior CABG`,
              data = plt_cabg))))

pdf("figures/Figure5A.pdf",  width=7, height=10)
plot(xBalance(`Female Surgeon` ~ `Medicare Status Code` + Race + Age +
                `Admission Day` + `Admission Type` + `CABG only` +
                `CABG primary` + `Surgery Year` + `Hospital Volume` +
                `Prior CABG`,
              data = plt_cabg))
dev.off()
```


## Assignment-Control

First, I reserved 10% of the control data as a pilot set to train a prognostic model.  Then I trained a propensity score model on the entire dataset.  The plot below shows an assignment-control plot from the fitted propensity and prognostic scores.  In order to avoid overplotting, only a subsample of 400 observations is shown.

```{r include=FALSE}
set.seed(123)
split.full <- split_pilot_set(cabg_cleaned, treat = "SEX_GENDER_MATCH",
                           pilot_fraction = 0.1,
                           group_by_covariates = c("BENE_RSDNC_SSA_STATE_CD"))

mystrata <- auto_stratify(cabg_cleaned, "SEX_GENDER_MATCH", MORT_30_DAY ~ BENE_MDCR_STUS_CD + 
                    BENE_RACE_CD + BENE_AGE_CNT + IP_ADMSN_TYPE_CD +
                    cabg_only + cabg_primary + indexSurgyear + hosp_vol_99_10 +
                    hosp_mvol_99_10 + prior_cabg, pilot_fraction = 0.1)

prog_model <- glm(MORT_30_DAY ~ BENE_MDCR_STUS_CD + 
                    BENE_RACE_CD + BENE_AGE_CNT + IP_ADMSN_TYPE_CD +
                    cabg_only + cabg_primary + indexSurgyear + hosp_vol_99_10 +
                    hosp_mvol_99_10 + prior_cabg,
                  family = binomial(), data = split.full$pilot_set)
summary(prog_model)

prog_scores <- predict(prog_model, newdata = split.full$analysis_set)

prop_model <- glm(SEX_GENDER_MATCH ~ BENE_MDCR_STUS_CD + 
                    BENE_RACE_CD + BENE_AGE_CNT + ADMSN_DAY_CD + IP_ADMSN_TYPE_CD +
                    cabg_only + cabg_primary + indexSurgyear + hosp_vol_99_10 +
                    hosp_mvol_99_10 + prior_cabg ,
                  family = binomial(), data = cabg_cleaned)

summary(prop_model)

prop_scores <- predict(prop_model, newdata = split.full$analysis_set)
```


```{r}
set.seed(124)
a_set.full <- split.full$analysis_set %>%
  mutate(prop = prop_scores,
         prog = prog_scores,
         t = SEX_GENDER_MATCH ) %>%
  sample_n(size = 400)

b <- AC_plot2(a_set.full, shaded_class = "none")
b
```

This assignment-control plot is quite favorable.  We can also make some propensity score histograms - which also look quite good.

```{r fig.height=6, fig.width=7}
plt_data <- split.full$analysis_set %>% 
      mutate(prog = prog_scores, 
           prop = prop_scores,
           t = as.factor(SEX_GENDER_MATCH)) %>%
      dplyr::select(c(t, prog, prop))
    
c <- ggplot(plt_data, aes(x = prop, y=..density.., fill = t)) + 
  geom_histogram(alpha = 0.4, position = "identity") +
  scale_fill_brewer(palette = "Set1", direction = -1) +
  theme(legend.position = "none") +
  xlab(expression(paste("Propensity, ", phi, "(x)", sep = ""))) +
  ylab("Density")

ggarrange(a, 
          ggarrange(b,c, ncol = 1, nrow = 2, labels = c("B", "C")),
          ncol = 2, nrow = 1, labels = "A", widths = c(4, 2))
```

```{r fig.width=2.5, fig.height=5}
ggarrange(b,c, ncol = 1, nrow = 2, labels = c("B", "C"), heights = c(3, 2))

pdf("figures/Figure5BC.pdf",  width=2.5, height=5)
ggarrange(b,c, ncol = 1, nrow = 2, labels = c("B", "C"), heights = c(3, 2))
dev.off()
```


## Matching

This dataset is really large, so matching is a nontrivial computational feat.  We might consider just matching a subsample of 2000 individuals.

```{r}
set.seed(123)
a_subsample <- split.full$analysis_set %>%
  mutate(prog = prog_scores, 
           prop = prop_scores,
         t = SEX_GENDER_MATCH) %>%
  sample_n(2000)
```

```{r}
AC_match_plot <- function(data, match, k = 1, title = ""){
  n_pairs <- sum(!is.na(match))/(k + 1)
  
  plt_data <- data %>% 
    mutate(m = match) %>%
    mutate(a = ifelse (is.na(m), 0.9, 1), 
           t = as.factor(abs(1-t))) %>% 
    dplyr::select(c(t, prog, prop, m, a))
  
  m_data <- plt_data %>% 
    filter(!is.na(m)) %>%
    arrange(m, desc(t)) %>% 
    mutate(id = rep(1:(k + 1), n_pairs)) %>%
    dplyr::select(-c(t, a)) %>%
    group_by(m) %>%
    summarize(prop1 = first(prop), prop2 = last(prop),
              prog1 = first(prog), prog2 = last(prog)) %>%
    dplyr::select(prog1, prog2, prop1, prop2)
  
  plt <- ggplot(data = plt_data, aes( x = prop, y = prog, group = t, color = t)) + 
    geom_point(aes(alpha = a), size = 1) +
    scale_color_brewer(palette="Set1") +
    geom_segment(data = m_data, 
                 aes(x = prop1, y = prog1,
                     xend = prop2, yend = prog2),
                 color =  "black", group = NA, linetype = "dashed") +
    ggtitle( title)+
    theme(legend.position = "none", aspect.ratio=1, plot.title = element_text(hjust = 0.5, size = 9))+
    ylab(expression(paste("Prognosis, ", Psi, "(x)", sep = ""))) +
    xlab(expression(paste("Propensity, ", phi, "(x)", sep = "")))
  
  return(plt)
}
```


```{r}
# mahalanobis match
mahal_dist <- match_on(SEX_GENDER_MATCH ~ BENE_MDCR_STUS_CD + 
                    BENE_RACE_CD + BENE_AGE_CNT + IP_ADMSN_TYPE_CD +
                    cabg_only + cabg_primary + indexSurgyear + hosp_vol_99_10 +
                    hosp_mvol_99_10 + prior_cabg, data = a_subsample)
mahal_caliper_dist <- addcaliper(mahal_dist, z = a_subsample$SEX_GENDER_MATCH,
                                 p = a_subsample$prop, caliper = 0.1)
mahal_jointcaliper_dist <- addcaliper(mahal_caliper_dist, z = a_subsample$SEX_GENDER_MATCH,
                                 p = a_subsample$prog, caliper = 0.1)
m_jointcaliper_match <- pairmatch(mahal_jointcaliper_dist, controls = 1, a_subsample)
m_caliper_match <- pairmatch(mahal_caliper_dist, controls = 1, a_subsample)
m_match <- pairmatch(mahal_dist, controls = 1, a_subsample)

AC_match_plot(a_subsample, m_jointcaliper_match)

AC_plot2(a_subsample)

b <- AC_match_plot(a_subsample, m_match)
AC_match_plot(a_subsample, m_caliper_match)

```

```{r fig.height=7, fig.width= 5}
plt_cabg <- a_subsample %>%
  select(SEX_GENDER_MATCH, BENE_MDCR_STUS_CD, BENE_RACE_CD, BENE_AGE_CNT, 
         ADMSN_DAY_CD, IP_ADMSN_TYPE_CD, cabg_only, cabg_primary, indexSurgyear,
         hosp_vol_99_10, hosp_mvol_99_10, prior_cabg, ISCHEMICHEART_EVER_bfadmin,
         HYPERL_EVER_bfadmin, HYPERT_EVER_bfadmin)

colnames(plt_cabg) <- c("Female Surgeon", "Medicare Status Code", "Race", "Age",
                        "Admission Day", "Admission Type", "CABG only", "CABG primary", "Surgery Year",
                        "Hospital Volume", "Prior CABG", "Prior Ischemia",
                        "Prior Hyperlipidemia", "Prior Hypertension")

plot(xBalance(`Female Surgeon` ~ `Medicare Status Code` + Race + Age +
                `Admission Day` + `Admission Type` + `CABG only` +
                `CABG primary` + `Surgery Year` + `Hospital Volume` +
                `Prior CABG` + strata(m_caliper_match),
              data = plt_cabg))

 a <- as.ggplot(expression(plot(xBalance(`Female Surgeon` ~ `Medicare Status Code` + Race + Age +
                `Admission Day` + `Admission Type` + `CABG only` +
                `CABG primary` + `Surgery Year` + `Hospital Volume` +
                `Prior CABG` + strata(m_caliper_match),
              data = plt_cabg))))
 
pdf("figures/Figure6A.pdf",  width=7, height=10)
plot(xBalance(`Female Surgeon` ~ `Medicare Status Code` + Race + Age +
                `Admission Day` + `Admission Type` + `CABG only` +
                `CABG primary` + `Surgery Year` + `Hospital Volume` +
                `Prior CABG` + strata(m_match),
              data = plt_cabg))
dev.off()

pdf("figures/Figure6B.pdf",  width=4, height=4)
ggarrange(b, ncol = 1, nrow = 1, labels = "B")
dev.off()
```


